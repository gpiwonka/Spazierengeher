@page "/settings"
@using Spazierengeher.Data
@using Spazierengeher.BlazorServices
@inject BlazorStepCounterService StepCounterService

<h3>Einstellungen</h3>

<div class="settings-container">
    @if (settings != null)
    {
        <!-- TRACKING STEUERUNG -->
        <div class="settings-section tracking-control">
            <h4>🎯 Tracking Steuerung</h4>
            <div class="tracking-status">
                @if (isTracking)
                {
                    <div class="tracking-active">
                        <span class="tracking-icon">✓</span>
                        <span class="tracking-text">Tracking läuft</span>
                    </div>
                    <button class="btn btn-stop-tracking" @onclick="StopTracking" disabled="@isChangingTracking">
                        @(isChangingTracking ? "Stoppe..." : "Tracking stoppen")
                    </button>
                    <p class="tracking-info">Schritte werden automatisch im Hintergrund gezählt.</p>
                }
                else
                {
                    <div class="tracking-inactive">
                        <span class="tracking-icon">⏸</span>
                        <span class="tracking-text">Tracking pausiert</span>
                    </div>
                    <button class="btn btn-start-tracking" @onclick="StartTracking" disabled="@isChangingTracking">
                        @(isChangingTracking ? "Starte..." : "Tracking starten")
                    </button>
                    <p class="tracking-info">Starte das Tracking, um Schritte zu zählen.</p>
                }
            </div>
        </div>

        <div class="settings-section">
            <h4>Tagesziel</h4>
            <div class="setting-item">
                <label for="dailyGoal">Schritte pro Tag</label>
                <input type="number" id="dailyGoal" @bind="settings.DailyGoal" min="1000" max="50000" step="1000" />
            </div>
        </div>

        <div class="settings-section">
            <h4>Persönliche Daten</h4>
            <div class="setting-item">
                <label for="weight">Gewicht (kg)</label>
                <input type="number" id="weight" @bind="settings.WeightKg" min="30" max="200" step="0.5" />
                <small>Für präzisere Kalorienberechnung</small>
            </div>
            <div class="setting-item">
                <label for="stepLength">Schrittlänge (m)</label>
                <input type="number" id="stepLength" @bind="settings.StepLengthMeters" min="0.4" max="1.2" step="0.01" />
                <small>Für genauere Distanzberechnung</small>
            </div>
        </div>

        <div class="settings-section">
            <h4>Tracking-Optionen</h4>
            <div class="setting-item checkbox-item">
                <input type="checkbox" id="notifications" @bind="settings.NotificationsEnabled" />
                <label for="notifications">Benachrichtigungen aktivieren</label>
            </div>
        </div>

        <div class="button-container">
            <button class="btn btn-save" @onclick="SaveSettings" disabled="@isSaving">
                @if (isSaving)
                {
                    <span>Speichern...</span>
                }
                else
                {
                    <span>Einstellungen speichern</span>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(isError ? "alert-error" : "alert-success")">
                @message
            </div>
        }

        <div class="info-section">
            <h4>ℹ️ Hinweise</h4>
            <ul>
                <li><strong>Schrittlänge messen:</strong> Laufe 10 Schritte und messe die Distanz, teile dann durch 10.</li>
                <li><strong>Kalorienberechnung:</strong> Basiert auf deinem Gewicht und ist ein Durchschnittswert.</li>
                <li><strong>Auto-Start:</strong> Praktisch für tägliches Tracking, kann aber den Akkuverbrauch erhöhen.</li>
            </ul>
        </div>
    }
</div>

@code {
    private UserSettings settings;
    private bool isSaving = false;
    private bool isChangingTracking = false;
    private bool isTracking = false;
    private string message = string.Empty;
    private bool isError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        isTracking = StepCounterService.IsTracking;
    }

    private async Task StartTracking()
    {
        isChangingTracking = true;
        message = string.Empty;
        StateHasChanged();

        try
        {
            var result = await StepCounterService.StartTrackingAsync();

            if (result.Success)
            {
                isTracking = true;
                message = "✓ Tracking gestartet";
                isError = false;
            }
            else
            {
                message = result.Message;
                isError = true;
            }

            await Task.Delay(3000);
            message = string.Empty;
        }
        catch (Exception ex)
        {
            message = $"Fehler: {ex.Message}";
            isError = true;
        }
        finally
        {
            isChangingTracking = false;
            StateHasChanged();
        }
    }

    private async Task StopTracking()
    {
        isChangingTracking = true;
        message = string.Empty;
        StateHasChanged();

        try
        {
            var result = await StepCounterService.StopTrackingAsync();

            if (result.Success)
            {
                isTracking = false;
                message = "✓ Tracking gestoppt";
                isError = false;
            }
            else
            {
                message = result.Message;
                isError = true;
            }

            await Task.Delay(3000);
            message = string.Empty;
        }
        catch (Exception ex)
        {
            message = $"Fehler: {ex.Message}";
            isError = true;
        }
        finally
        {
            isChangingTracking = false;
            StateHasChanged();
        }
    }


    private async Task LoadSettings()
    {
        try
        {
            await StepCounterService.ReloadSettingsAsync();
            // Erstelle eine Kopie für Bearbeitung
            var current = StepCounterService.Settings;
            settings = new UserSettings
            {
                Id = current.Id,
                DailyGoal = current.DailyGoal,
                WeightKg = current.WeightKg,
                StepLengthMeters = current.StepLengthMeters,
                NotificationsEnabled = current.NotificationsEnabled,
                AutoStartTracking = current.AutoStartTracking,
                CreatedAt = current.CreatedAt,
                UpdatedAt = current.UpdatedAt
            };
        }
        catch (Exception ex)
        {
            message = $"Fehler beim Laden: {ex.Message}";
            isError = true;
        }
    }

    private async Task SaveSettings()
    {
        isSaving = true;
        message = string.Empty;
        StateHasChanged();

        try
        {
            // Validierung
            if (settings.DailyGoal < 1000)
            {
                message = "Das Tagesziel muss mindestens 1.000 Schritte sein.";
                isError = true;
                return;
            }

            if (settings.WeightKg < 30 || settings.WeightKg > 200)
            {
                message = "Bitte gib ein realistisches Gewicht ein (30-200 kg).";
                isError = true;
                return;
            }

            if (settings.StepLengthMeters < 0.4 || settings.StepLengthMeters > 1.2)
            {
                message = "Bitte gib eine realistische Schrittlänge ein (0.4-1.2 m).";
                isError = true;
                return;
            }

            await StepCounterService.UpdateSettingsAsync(settings);
            message = "Einstellungen erfolgreich gespeichert!";
            isError = false;

            // Kurz warten und dann Nachricht ausblenden
            await Task.Delay(3000);
            message = string.Empty;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            message = $"Fehler beim Speichern: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
}
